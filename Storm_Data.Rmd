---
title: "Economic Consequences & Population Health Hazards of Severe Weather"
author: "EHarris"
date: "6/06/2017"
output: 
  html_document: 
    keep_md: yes
---

## Load anticipated packages to be used throughout Course 5 Project 1
```{r setup, include=FALSE}
ipak <- function(pkg){
      new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
      if (length(new.pkg)) 
            install.packages(new.pkg, dependencies = TRUE)
      sapply(pkg, require, character.only = TRUE)
}

### Package Usage
packages <- c("plyr", "dplyr", "data.table", "dtplyr", "lubridate", "ggplot2", "scales",
                  "reshape2", "knitr", "R.cache", "stringr", "gtools", "quantreg")
ipak(packages)
```

### Analysis Synopsis
Due to the different types, and serverity, of weather experienced throughout a country, there is a desire to understand weather events that create the greatest economic consequences or most hazardous with respect to population health.  

We will be using data provided by the National Oceanic and Atmospheric Administration (NOAA) to help answer these questions.  Economic consequences are measured by the amount of damage, property and/or crop, that is associated with each event type.  The population health hazard is measured by the number of fatalities and/or injuries with an event.  The number of fatalities will be the primary metric for determining the population health hazard.

### Data Processing  
A first step to our analysis is reading the data into R from the working directory. The data provided is a zipped csv file.  We unzip and read into R using read.csv file.  The code to read in the file, as well as a couple summaries of the data.

##### Read zipped csv file into R
```{r read_storm_data, include = TRUE, cache = TRUE}
StormData <- read.csv("repdata-data-StormData.csv.bz2", header = TRUE, sep = ",",
                        quote = "\"", dec = ".")

##### A quick overview of the data in this file:
dim(StormData)

str(StormData)
```

##### Create Econonmic Consequencences metric for each event, event type & REFNUM
To facilitate analysis, it is necessary to modify the orginal data in some cases.  As an  
example, the dollar amounts for property damage are expressed in different denomiations  
(e.g. thousand vs. millions of dollars).  It is important to define a consistent measure  
so that dollars can be combined, or summed, for different levels of aggregation, as  
appropriate.
```{r economic_measure, include = TRUE}
StormData$PROPDMG <- StormData$PROPDMG * ifelse(StormData$PROPDMGEXP == "K", 1000,
                              ifelse(StormData$PROPDMGEXP == "M", 1000000,
                              ifelse(StormData$PROPDMGEXP == "B", 1000000000, 1)))
StormData$CROPDMG <- StormData$CROPDMG * ifelse(StormData$CROPDMGEXP == "K", 1000,
                              ifelse(StormData$CROPDMGEXP == "M", 1000000,
                              ifelse(StormData$CROPDMGEXP == "B", 1000000000, 1)))
StormData$ECONOMIC <- StormData$PROPDMG + StormData$CROPDMG
```

##### Define period for aggregating measurement data, population health & economic
A second area that requires some clean-up are the dates and times at the beginning and 
end of an event.  From documentation provided by the National Westher Service, some notes about the time of an event,

"In general, the time of an event, as it appears in the header-strip, is the time when 
the event reached locally, regionally, or nationally established advisory or warning criteria (exceptions defined in Section 2.3.1). The event time could be the single time that a peak wind gust of 65 knots (75 mph) occurred, or it could be beginning and ending times of a 10-minute shower of large, damaging hailstones. If the time of the event in 
the header-strip is a broad guesstimate,then it should be indicated as such in the event narrative."

For our analysis, the specific event times is not critical to assessing the hazard to population health or the amount of economic consequences.  The results will summarized to a calendar year based on BGN_DATE in the data provided.  In addition to converting BGN_DATE to a date format, we are adding a 'YEAR' column.

As END_DATE and END_TIME are infrequently populated, these variables will not be used in our analysis.  This also minimizes the need to further process the variables.
```{r event_dates, include = TRUE}
StormData$BGN_DATE <- as.Date(StormData$BGN_DATE, "%m/%d/%Y")
StormData$BGN_YEAR <- format(StormData$BGN_DATE, "%Y")
StormData$hour <- as.numeric(substr(StormData$BGN_TIME, 1, 2))
StormData$minute <- substr(StormData$BGN_TIME, 3, 4)
StormData$ampm <- ifelse(StormData$hour > 12, "PM", "AM")
StormData$hour <- ifelse(StormData$hour > 12, StormData$hour - 12, 
                              ifelse(StormData$hour < 1, 12, StormData$hour))
StormData$hour <- substr(paste("00", StormData$hour, sep = ""), 
                         min(length(StormData$hour)+1,3),min(length(StormData$hour)+2, 4))

StormData$BGN_TIME <- paste(StormData$hour, ":", StormData$minute, " ", 
                                                      StormData$ampm, sep = "")
```

##### Defining the location or area for an event
There are four variables -- STATE, COUNTYNAME, LATITUDE, & LONGITUDE --  
that are well-populated and could be used to support analysis by location.  Only these 4  
variables are included in final, tidy,  dataset to be used for analysis.  Other location  
related variables are sparsely populated.

##### Final data set to be used for analysis
We will not be keeping many of the poorly populated variables provided in the zip file  
we received.  They do not lend themselves to a further understanding of the questions  
for analysis.  

The final processing of the dataset is to limit the final dataset to data to BGN_Dates  
on or after "1980-01-01".  Although data captures events as early as 1950, there have  
been significant shifts in population density and development that may distort results  
by including the earlier years.
```{r subset_storm_data, include = TRUE, cache = TRUE}
subStormData <- select(StormData, REFNUM, BGN_YEAR, BGN_DATE, BGN_TIME, TIME_ZONE,
                       STATE, COUNTYNAME, LATITUDE, LONGITUDE, EVTYPE, F, MAG,
                       FATALITIES, INJURIES, PROPDMG, CROPDMG, ECONOMIC)
subStormData$ECONOMIC_MILL <- dollar(round(subStormData$ECONOMIC/1000000, digit = 3))

subStormData <- subset(subStormData, BGN_YEAR > "1979")
```

### Evaluating the Economic Consequences and Hazards to Population Health of Events
Using the available data, we have determined that our metric to assess the event type  
generating the greatest 'economonic consequence' is the combined cost for property damage  
(PROPDMG) and crop damage (CROPDMG).  The number of fatalities, captured by 'FATALITIES'  
variable in the data, will be used to measure the hazard to population health.  Although  
we recognize that injuries are, at a minimum, a contributing hazard to population  
health, it is difficult, likely impossible, to develop comparison to a fatality (e.g. 5  
injuries = 1 fatality).  If two event types have the same number of fatalities, the number  
of injuries may be considered for determing the greater hazard.  

As previously noted, our analysis includes data for events with a BGN_DATE of 1/1/1980  
or later.  The objective is to better reflect more current population density and  
development levels in various market.  This allows us to reflect, for example, the higher  
cost or hazard in coastal states due to hurricanes.  

When stating which 'Event Type' has the greatest economic consequence the statement is  
based on the total economic cost, property damage + crop damage, for each event over the  
entire period, 1980 - 2011.  Similarly, the total number of fatalities is used to  
determine the event type presenting the greatest hazard to population health.

NOTE:  Because some event types may occur with less frequency, but greater impact for each  
occurrence we have included a mean, or average, economic cost and fatalities of each  
event type.  Is the list of top 20 event types different?

##### Calculations of key metrics noted above
```{r event_impact_metrics, include = TRUE}
event.economic.sum <- aggregate(ECONOMIC_MILL ~ EVTYPE, data = subStormData, 
                                    FUN = function(x) sum=sum(x))
event.economic.sum <- event.economic.sum[order(event.economic.sum$ECONOMIC_MILL,
                                               decreasing = TRUE),]
event.economic.sum$ROW_INDX <- seq(along = event.economic.sum$EVTYPE)
event.economic.sum$EVENT_CTGY <- ifelse(event.economic.sum$ROW_INDX < 21,
                                          paste(event.economic.sum$EVTYPE), "OTHER EVENT")

event.economic.mean <- aggregate(ECONOMIC_MILL ~ EVTYPE, data = subStormData, 
                                    FUN = function(x) mean=mean(x))
event.economic.mean <- event.economic.mean[order(event.economic.mean$ECONOMIC_MILL,
                                               decreasing = TRUE),]
event.economic.mean$ROW_INDX <- seq(along = event.economic.mean$EVTYPE)
event.economic.mean$EVENT_CTGY <- ifelse(event.economic.mean$ROW_INDX < 21,
                                          paste(event.economic.mean$EVTYPE), "OTHER EVENT")


event.fatality.sum <- aggregate(FATALITIES ~ EVTYPE, data = subStormData, 
                                    FUN = function(x) sum=sum(x))
event.fatality.sum <- event.fatality.sum[order(event.fatality.sum$FATALITIES,
                                               decreasing = TRUE),]
event.fatality.sum$ROW_INDX <- seq(along = event.fatality.sum$EVTYPE)
event.fatality.sum$EVENT_CTGY <- ifelse(event.fatality.sum$ROW_INDX < 21,
                                          paste(event.fatality.sum$EVTYPE), "OTHER EVENT")

event.fatality.mean <- aggregate(FATALITIES ~ EVTYPE, data = subStormData, 
                                    FUN = function(x) mean=mean(x))
event.fatality.mean <- event.fatality.mean[order(event.fatality.mean$FATALITIES,
                                               decreasing = TRUE),]
event.fatality.mean$ROW_INDX <- seq(along = event.fatality.mean$EVTYPE)
event.fatality.mean$EVENT_CTGY <- ifelse(event.fatality.mean$ROW_INDX < 21,
                                          paste(event.fatality.mean$EVTYPE), "OTHER EVENT")
```

##### Plot results for each of the top 20 Event Types
```{r plot_metrics_by_event, fig.keep = "all", fig.show = "asis", fig.path = 'figure/'}
par(mfrow = c(2, 2), mar = c(4, 4, 2, 1), oma = c(0, 0, 2, 0))
theme_update(plot.title = element.text(hjust = 0.5))
qplot(BGN_YEAR, ECONOMIC_MILL, data = event.economic.sum, color = EVTYPE, 
                  geom = c("point", "smooth"),
                  main = "Total Economic Consequence by Event (1980 - 2011)", 
                  xlab = "Measurement Year", ylab = "Total Cost (in Millions)")
qplot(BGN_YEAR, ECONOMIC_MILL, data = event.economic.mean, color = EVTYPE, 
                  geom = c("point", "smooth"),
                  main = "Average Economic Consequence per Occurrence (1980 - 2011)", 
                  xlab = "Measurement Year", ylab = "Average Cost (in Millions)")
qplot(BGN_YEAR, FATALITIES, data = event.fatalities.sum, color = EVTYPE, 
                  geom = c("point", "smooth"),
                  main = "Total Fatalities by Event (1980 - 2011)", 
                  xlab = "Measurement Year", ylab = "Total Fatalities")
qplot(BGN_YEAR, FATALITIES, data = event.fatalities.mean, color = EVTYPE, 
                  geom = c("point", "smooth"),
                  main = "Average Fatalities per Occurrence (1980 - 2011)", 
                  xlab = "Measurement Year", ylab = "Average Fatalities")


ggplot(event.economic, aes(x = factor(BGN_YEAR), y = ECONOMIC_THSND, colour = EVTYPE)) +
      geom_line() +
      geom_point() +
      labs(title = "Economic Consequences of Weather Event") +
      labs(x = "Measurement Year", y = "Economic Cost")
```



